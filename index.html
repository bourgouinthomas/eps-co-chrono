<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chrono CO EPS</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="manifest" href="manifest.json">

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(()=>console.log("Service Worker OK"))
    .catch(err=>console.log("SW failed", err));
}
</script>

<style>
html,body{margin:0;height:100%;background:#0f172a;color:white}
.card{background:#020617}
button,input{font-size:1.25rem}
</style>
</head>

<body>

<header class="text-center py-4">
<h1 class="text-3xl font-bold">ğŸ§­ Chrono CO EPS</h1>
<p class="text-slate-400">Course d'orientation</p>
</header>

<div class="px-4 mb-4 flex gap-2">
<input id="newName" placeholder="Nom de l'Ã©lÃ¨ve"
 class="flex-1 bg-black text-white rounded px-4 py-3">
<button onclick="addStudent()"
 class="bg-white text-black px-6 rounded-xl font-bold">â•</button>
</div>

<div class="grid grid-cols-2 gap-3 px-4 mb-4">
<button onclick="startAll()" class="bg-green-600 py-4 rounded-xl font-bold">â–¶ START</button>
<button onclick="stopAll()" class="bg-red-600 py-4 rounded-xl font-bold">â¹ STOP</button>
<button onclick="resetAll()" class="bg-orange-600 py-4 rounded-xl font-bold">â†º RESET</button>
<button onclick="showResults()" class="bg-blue-600 py-4 rounded-xl font-bold">ğŸ“Š Classement</button>
</div>

<div id="list" class="px-4 space-y-3"></div>

<div class="px-4 mt-4">
<button onclick="exportCSV()"
 class="w-full bg-slate-700 py-4 rounded-xl font-bold">
ğŸ’¾ Export Excel (CSV)
</button>
</div>

<script>
let students = JSON.parse(localStorage.getItem("chronoCO")) || [];
let ticker=null;

function save(){localStorage.setItem("chronoCO",JSON.stringify(students));}
function fmt(ms){ const s=Math.floor(ms/1000); return `${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`; }

function startTicker(){ 
  if(ticker) return;
  ticker=setInterval(()=>{
    const now=performance.now();
    students.forEach(s=>{
      if(s.running){
        s.elapsed = now - s.start;
        const el = document.getElementById("t"+s.id);
        if(el) el.textContent = fmt(s.elapsed);
      }
    });
  },200);
}
function stopTicker(){ clearInterval(ticker); ticker=null; }

function addStudent(){
  const input=document.getElementById("newName"); 
  const name=input.value.trim();
  if(!name){alert("Nom requis");return;}
  students.push({id:Date.now(),name,elapsed:0,start:0,running:false,races:[]});
  input.value=""; save(); render();
}
function rename(id){ 
  const s=students.find(e=>e.id===id); 
  const n=prompt("Modifier le nom :",s.name); 
  if(n){s.name=n;save();render();}
}
function removeStudent(id){ 
  if(!confirm("Supprimer cet Ã©lÃ¨ve ?"))return; 
  students=students.filter(s=>s.id!==id); 
  save();render(); 
}

function startAll(){ 
  const now=performance.now(); 
  students.forEach(s=>{ 
    if(!s.running){ s.start=now-s.elapsed; s.running=true; } 
  }); 
  startTicker(); save(); render();
}
function stopAll(){ students.forEach(s=>s.running=false); stopTicker(); save(); render();}
function resetAll(){ 
  if(!confirm("RÃ©initialiser tous les chronos ?"))return; 
  students.forEach(s=>{s.elapsed=0;s.running=false;}); 
  stopTicker(); save(); render();
}
function toggle(id){ 
  const s=students.find(e=>e.id===id); 
  if(!s.running){ 
    s.start=performance.now()-s.elapsed; 
    s.running=true; 
    startTicker(); 
  } else s.running=false; 
  save(); render(); 
}
function resetOne(id){ 
  const s=students.find(e=>e.id===id); 
  s.elapsed=0;s.running=false; save(); render(); 
}

function validateOne(id){
  const s=students.find(e=>e.id===id);
  if(s.elapsed<=0) return;
  s.races.push({date:new Date().toLocaleString(),time:s.elapsed});
  s.elapsed=0;s.running=false; save(); render();
}

function render(){
  const box=document.getElementById("list"); box.innerHTML="";
  students.forEach(s=>{
    box.innerHTML+=`
    <div class="card p-4 rounded-xl border border-slate-700">
      <div class="flex justify-between mb-2">
        <span class="text-xl font-semibold">${s.name}</span>
        <div class="space-x-2">
          <button onclick="rename(${s.id})" class="bg-slate-600 px-2 rounded text-white">âœï¸</button>
          <button onclick="removeStudent(${s.id})" class="bg-red-700 px-2 rounded text-white">âœ–</button>
        </div>
      </div>
      <div id="t${s.id}" class="text-center text-6xl font-mono font-bold mb-3">${fmt(s.elapsed)}</div>
      <div class="grid grid-cols-3 gap-2">
        <button onclick="toggle(${s.id})" class="py-3 rounded text-white font-bold ${s.running ? 'bg-red-600' : 'bg-green-600'}">
          ${s.running ? 'STOP' : 'START'}
        </button>
        <button onclick="resetOne(${s.id})" class="bg-orange-600 py-3 rounded text-white font-bold">RESET</button>
        <button onclick="validateOne(${s.id})" class="bg-emerald-600 py-3 rounded text-white font-bold">ğŸ’¾</button>
      </div>
      <div class="text-sm text-slate-400 mt-2">Courses : ${s.races.length}</div>
    </div>`;
  });
}

function showResults(){
  const rows=[];
  students.forEach(s=>{ 
    if(s.races.length){ 
      const last=s.races.at(-1).time; 
      const best=Math.min(...s.races.map(r=>r.time)); 
      rows.push({name:s.name,last,best}); 
    } 
  });
  rows.sort((a,b)=>a.last-b.last);
  const w=window.open(""); 
  w.document.write(`<h1>Classement</h1><table border="1" cellpadding="8"><tr><th>#</th><th>Nom</th><th>DerniÃ¨re</th><th>Meilleure</th></tr>`);
  rows.forEach((r,i)=>{w.document.write(`<tr><td>${i+1}</td><td>${r.name}</td><td>${fmt(r.last)}</td><td>${fmt(r.best)}</td></tr>`);});
  w.document.write(`</table>`);
}

function exportCSV(){
  let csv="Nom;NumÃ©ro de course;Date;Temps\n";
  students.forEach(s=>{
    s.races.forEach((r,i)=>{
      csv+=`${s.name};${i+1};${r.date};${fmt(r.time)}\n`;
    });
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="chrono_CO_EPS.csv";
  a.click();
}

render();
</script>
</body>
</html>
